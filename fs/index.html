
<!DOCTYPE html>
<html>
  <head>

    <script src="./NexusUI.min.js"></script>
    <script src="./magic_grid.min.js"></script>

    <style>
      .container div {
        width: 100%;
        height: 100%;
        background-color: antiquewhite;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 8px;
      }
      .ctrlpanel { width: 150px; margin:10px; border-color: rgb(222, 219, 231); border-width: 1px; border-style:solid; padding: 10px;}
      #loss {background-color: green; padding: 4px;}
    </style>

  </head>
  <body>

    <div id="container">
      <div id="modelCtrl" class="ctrlpanel">
        <div>
          Models
          <div id="modelSelector"></div>
        </div>
        <div>
          <div id="resetModelButton"></div>
        </div>
      </div>
      <div id="dataCtrl" class="ctrlpanel">
        <div>
          Datasets
          <div id="datasetSelector"></div>
        </div>
        <div>
          <div id="clearDataButton"></div>
        </div>
      </div>
      <div id="trainCtrl" class="ctrlpanel">
        Training
        <div id="trainButton"></div>
        Iterations <div id="numIterations"></div>
        <div id="iterationsSlider"></div>
        <div>Loss: <span id="loss">Loading...</span></div>
      </div>
      <div id="explorationCtrl" class="ctrlpanel">
        Exploration
        Range: <div id="rangeSlider"></div>
        Mode:
        <div id="exploModeSelect"></div>

      </div>
    </div>


    <script>

      const idx_of = {
        "randomSpeed": 0,
        "nIterations": 1
      };

      let grid = new MagicGrid({container: "#container", // Required. Can be a class, id, or an HTMLElement.
        static: true, // Required for static content.
        animate: true} // Optional.
        );

      console.log(grid);
      grid.listen();

      var slider_queue = [];

      function run() {
        if (slider_queue.length > 0) {
          // Take the last element
          const work = slider_queue[slider_queue.length - 1];
          if (work !== undefined) {
            const idx = work[0];
            const val = work[1];
            fetch("/dials.cgi?s=" + idx + "&v=" + val);
          }
          // Clear array
          slider_queue.length = 0;
        }
      }

      setInterval(run, 100);

      var datasetRadios = new Nexus.RadioButton('#datasetSelector',{
        'size': [150,35],
        'numberOfButtons': 4,
        'active': 0
      })

      var modelRadios = new Nexus.RadioButton('#modelSelector',{
        'size': [150,35],
        'numberOfButtons': 4,
        'active': 0
      })

      var btnResetModel = new Nexus.TextButton('#resetModelButton',{
        'size': [120,40],
        'mode': 'button',
        'state': false,
        'text': "Reset"
      })
      var btnClearData = new Nexus.TextButton('#clearDataButton',{
        'size': [120,40],
        'mode': 'button',
        'state': false,
        'text': "Clear"
      })
      var btnTrain = new Nexus.TextButton('#trainButton',{
        'size': [120,40],
        'mode': 'button',
        'state': false,
        'text': "Train"
      })

      var numboxIterations = new Nexus.Number('#numIterations',{
        'size': [60,30],
        'value': 0,
        'min': 1,
        'max': 300,
        'step': 1
      })

      var sliderIterations = new Nexus.Slider('#iterationsSlider',{
          'size': [150,30],
          'mode': 'absolute',  // 'relative' or 'absolute'
          'min': 1,
          'max': 1000,
          'step': 1,
          'value': 0
      })

      numboxIterations.link(sliderIterations);

      var sliderIterations_uichange = true;
      sliderIterations.on('change',function(v) {
        if (sliderIterations_uichange === true) {
          // v is the value of the button
          console.log(v);
          slider_queue.push([idx_of["nIterations"], v]);
        }
        sliderIterations_uichange = true;
      })

      var sliderRange = new Nexus.Slider('#rangeSlider',{
          'size': [150,30],
          'mode': 'absolute',  // 'relative' or 'absolute'
          'min': 0,
          'max': 1,
          'step': 0,
          'value': 0.5
      })

      var sliderRange_uichange = true;
      sliderRange.on('change',function(v) {
        if (sliderRange_uichange === true) {
          // v is the value of the button
          console.log(v);
          slider_queue.push([idx_of["randomSpeed"], v]);
        }
        sliderRange_uichange = true;
      });

      var exploModeSelect = new Nexus.Select('#exploModeSelect',{
        'size': [100,30],
        'options': ['nn weight','pretrain', 'zoom']
      })

      /*
      var button1 = new Nexus.Button('#button1',{
        'size': [75,75],
        'mode': 'aftertouch',
        'state': false
      })
      button1.on('change',function(v) {
        // v is the value of the button
        console.log(v.state);
        fetch("/buttons.cgi?b=0&v=" + (v.state ? 1 : 0));
      })
      var button2 = new Nexus.Button('#button2',{
        'size': [75,75],
        'mode': 'aftertouch',
        'state': false
      })
      button2.on('change',function(v) {
        // v is the value of the button
        console.log(v.state);
        fetch("/buttons.cgi?b=1&v=" + (v.state ? 1 : 0));
      })

      var button3 = new Nexus.Button('#button3',{
        'size': [75,75],
        'mode': 'aftertouch',
        'state': false
      })
      button3.on('change',function(v) {
        // v is the value of the button
        console.log(v.state);
        fetch("/buttons.cgi?b=2&v=" + (v.state ? 1 : 0));
      })
      var button4 = new Nexus.Button('#button4',{
        'size': [75,75],
        'mode': 'aftertouch',
        'state': false
      })
      button4.on('change',function(v) {
        // v is the value of the button
        console.log(v.state);
        fetch("/buttons.cgi?b=3&v=" + (v.state ? 1 : 0));
      })
      */

      // var dial = new Nexus.Dial('#dial')
      // dial.on('change',function(v) {
      //   if (work_queue.length == 0) {
      //     work_queue.push(v);
      //   }
      // });
      // var dial = new Nexus.Dial('#dial2')
      // var sequencer = new Nexus.Sequencer('#seq',{
      //   'size': [400,200],
      //   'mode': 'toggle',
      //   'rows': 5,
      //   'columns': 10,
      //   'paddingRow': 10,
      //   'paddingColumn': 20
      //   })

      async function getJSON() {
        const response = await fetch("/ssi.shtml");
        if (!response.ok) {
            console.log("poll error")
          }
          // Parse the response as JSON
          const data = await response.json();
          //console.log(data);
          // Last error
          document.getElementById('loss').innerText = data.last_error;
          // Expl range
          sliderRange_uichange = false;
          sliderRange.value = data.exploration_range;
          // N iterations
          sliderIterations_uichange = false;
          sliderIterations.value = data.n_iterations;
      }
      setInterval(getJSON, 100);

    </script>


  </body>
</html>